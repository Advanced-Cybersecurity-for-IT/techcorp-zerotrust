# ============================================================================
# SQUID PROXY CONFIGURATION
# TechCorp Zero Trust Architecture - Layer 7 Application Firewall
# ============================================================================
# This Squid instance acts as a transparent proxy that:
# 1. Receives traffic forwarded from iptables firewall
# 2. Applies domain/URL-based access control (Layer 7)
# 3. Forwards allowed traffic to PEP
# ============================================================================

# ----------------------------------------------------------------------------
# NETWORK CONFIGURATION
# ----------------------------------------------------------------------------
# Accelerator mode - act as reverse proxy forwarding to PEP
# This receives traffic from iptables-firewall and forwards to PEP
http_port 3128 accel defaultsite=pep vhost allow-direct

# Cache peer - forward all traffic to PEP
# PEP is the upstream origin server
# login=PASS forwards Authorization header to origin server
cache_peer pep parent 8080 0 no-query originserver login=PASS name=pep

# ----------------------------------------------------------------------------
# ACCESS CONTROL LISTS (ACLs)
# ----------------------------------------------------------------------------

# Standard ACLs
acl localhost src 127.0.0.1/32
acl to_localhost dst 127.0.0.0/8

# Network ACLs - Define trusted networks
acl internal_net src 172.28.2.0/24
acl dmz_net src 172.28.3.0/24
acl prod_net src 172.28.4.0/24
acl dev_net src 172.28.5.0/24
acl external_net src 172.28.1.0/24

# Whitelisted external IPs (allowed through L3 firewall)
acl whitelisted_external src 172.28.1.100 172.28.1.50

# Safe ports
acl Safe_ports port 80          # http
acl Safe_ports port 443         # https
acl Safe_ports port 8080        # http-alt (PEP)
acl Safe_ports port 8180        # Keycloak

# SSL ports (for CONNECT method if needed later)
acl SSL_ports port 443

# CONNECT method
acl CONNECT method CONNECT

# ----------------------------------------------------------------------------
# DOMAIN BLACKLIST (Layer 7 Filtering)
# ----------------------------------------------------------------------------
# Block malicious/unauthorized domains
acl blocked_domains dstdomain "/etc/squid/blocked_domains.txt"

# Additional inline blocked patterns
acl blocked_domain_patterns dstdomain .malware-site.com
acl blocked_domain_patterns dstdomain .phishing-site.com
acl blocked_domain_patterns dstdomain .hacker-tools.org

# Block specific servers in the lab environment
acl blocked_servers dstdomain external-blocked-server
acl blocked_servers dstdomain blocked-server

# ----------------------------------------------------------------------------
# URL REGEX PATTERNS (Advanced L7 Filtering)
# ----------------------------------------------------------------------------
# Block suspicious URL patterns
acl suspicious_urls urlpath_regex -i \.exe$
acl suspicious_urls urlpath_regex -i \.bat$
acl suspicious_urls urlpath_regex -i \.cmd$
acl suspicious_urls urlpath_regex -i \.ps1$
acl suspicious_urls urlpath_regex -i /etc/passwd
acl suspicious_urls urlpath_regex -i /etc/shadow
acl suspicious_urls urlpath_regex -i \.\./

# SQL Injection patterns in URL
acl sqli_patterns urlpath_regex -i union.*select
acl sqli_patterns urlpath_regex -i select.*from
acl sqli_patterns urlpath_regex -i insert.*into
acl sqli_patterns urlpath_regex -i drop.*table
acl sqli_patterns urlpath_regex -i or.*1.*=.*1
acl sqli_patterns urlpath_regex -i and.*1.*=.*1

# XSS patterns in URL
acl xss_patterns urlpath_regex -i <script
acl xss_patterns urlpath_regex -i javascript:
acl xss_patterns urlpath_regex -i onerror.*=
acl xss_patterns urlpath_regex -i onload.*=

# ----------------------------------------------------------------------------
# HTTP ACCESS RULES
# ----------------------------------------------------------------------------
# Deny requests to unsafe ports
http_access deny !Safe_ports

# Deny CONNECT to non-SSL ports
http_access deny CONNECT !SSL_ports

# ===== LAYER 7 BLOCKING RULES =====

# Block blacklisted domains (from file)
http_access deny blocked_domains

# Block inline blocked patterns
http_access deny blocked_domain_patterns

# Block specific blocked servers
http_access deny blocked_servers

# Block suspicious URLs (potential attacks)
http_access deny suspicious_urls

# Block SQL injection attempts
http_access deny sqli_patterns

# Block XSS attempts
http_access deny xss_patterns

# ===== ALLOW RULES =====

# Allow localhost
http_access allow localhost

# Allow from internal/trusted networks
http_access allow internal_net
http_access allow dmz_net
http_access allow prod_net
http_access allow dev_net

# Allow whitelisted external hosts
http_access allow whitelisted_external

# Allow from any source in external_net that passed iptables
# (iptables already filtered blacklisted IPs)
http_access allow external_net

# Deny all other access
http_access deny all

# ----------------------------------------------------------------------------
# CACHE CONFIGURATION
# ----------------------------------------------------------------------------
# Minimal caching for ZTA (we want fresh policy decisions)
cache deny all

# Cache directory (required even if not caching)
cache_dir null /tmp

# Memory cache
cache_mem 64 MB

# ----------------------------------------------------------------------------
# FORWARDING TO PEP
# ----------------------------------------------------------------------------
# Never go direct - always use the cache_peer (PEP)
never_direct allow all

# Route all traffic through PEP
cache_peer_access pep allow all

# ----------------------------------------------------------------------------
# LOGGING CONFIGURATION
# ----------------------------------------------------------------------------
# Access log format (compatible with SIEM/Splunk)
logformat zerotrust %ts.%03tu %6tr %>a %Ss/%03>Hs %<st %rm %ru %[un %Sh/%<a %mt "%{X-Real-IP}>h" "%{User-Agent}>h"

# Log to stdout for Docker (will be captured by Docker logs)
#access_log stdio:/dev/stdout zerotrust
access_log stdio:/var/log/squid/access.log zerotrust

# Cache log
#cache_log stdio:/dev/stderr
cache_log stdio:/var/log/squid/cache.log

# ----------------------------------------------------------------------------
# PERFORMANCE & TIMEOUTS
# ----------------------------------------------------------------------------
# Connection timeouts
connect_timeout 30 seconds
read_timeout 60 seconds
request_timeout 60 seconds

# Client timeouts
client_lifetime 1 hour
pconn_timeout 60 seconds

# ----------------------------------------------------------------------------
# SECURITY SETTINGS
# ----------------------------------------------------------------------------
# Hide Squid version
httpd_suppress_version_string on

# Forwarded-For header (preserve client IP)
forwarded_for on
follow_x_forwarded_for allow all

# Allow headers to pass through to PEP for JWT verification
# By default Squid may strip sensitive headers - we need them for Zero Trust auth
request_header_access All allow all
request_header_access Authorization allow all
request_header_access X-Real-IP allow all
request_header_access X-Forwarded-For allow all

# Via header
via on

# ----------------------------------------------------------------------------
# ERROR PAGES
# ----------------------------------------------------------------------------
# Custom error directory (optional)
# error_directory /etc/squid/errors

# Deny info for blocked content
deny_info TCP_DENIED blocked_domains
deny_info TCP_DENIED blocked_domain_patterns
deny_info TCP_DENIED blocked_servers
deny_info TCP_DENIED suspicious_urls
deny_info TCP_DENIED sqli_patterns
deny_info TCP_DENIED xss_patterns

# ----------------------------------------------------------------------------
# ADMINISTRATIVE
# ----------------------------------------------------------------------------
# Visible hostname
visible_hostname squid-proxy.techcorp.local

# Admin email
cache_mgr security@techcorp.local

# PID file
pid_filename /var/run/squid/squid.pid

# Coredump directory
coredump_dir /var/spool/squid
