# ============================================================================
# CONFIGURAZIONE SQUID PROXY
# TechCorp Zero Trust Architecture - Layer 7 Application Firewall
# ============================================================================
# Questa istanza Squid agisce come proxy che:
# 1. Riceve traffico inoltrato dal firewall iptables
# 2. Applica controllo accessi basato su domini/URL (Layer 7)
# 3. Inoltra il traffico consentito al PEP
# ============================================================================

# ----------------------------------------------------------------------------
# CONFIGURAZIONE DI RETE
# ----------------------------------------------------------------------------
# Reverse proxy inoltrando le richieste di accesso al PEP
http_port 3128 accel defaultsite=pep vhost allow-direct
cache_peer pep parent 8080 0 no-query originserver login=PASS name=pep

# ----------------------------------------------------------------------------
# ACCESS CONTROL LIST (ACL)
# ----------------------------------------------------------------------------

# ACL Standard
acl localhost src 127.0.0.1/32
acl to_localhost dst 127.0.0.0/8

# ACL di Rete
acl internal_net src 172.28.2.0/24
acl dmz_net src 172.28.3.0/24
acl prod_net src 172.28.4.0/24
acl dev_net src 172.28.5.0/24
acl external_net src 172.28.1.0/24

# IP esterni whitelistati
acl whitelisted_external src 172.28.1.100 172.28.1.50

# Porte sicure
acl Safe_ports port 80          # http
acl Safe_ports port 443         # https
acl Safe_ports port 8080        # PEP
acl Safe_ports port 8180        # Keycloak
acl SSL_ports port 443

acl CONNECT method CONNECT

# ----------------------------------------------------------------------------
# BLACKLIST DOMINI
# ----------------------------------------------------------------------------
# Blocca domini malevoli/non autorizzati
acl blocked_domains dstdomain "/etc/squid/blocked_domains.txt"

# Pattern domini bloccati
acl blocked_domain_patterns dstdomain .malware-site.com
acl blocked_domain_patterns dstdomain .phishing-site.com
acl blocked_domain_patterns dstdomain .hacker-tools.org

# Blocca server specifici nell'ambiente lab
acl blocked_servers dstdomain external-blocked-server
acl blocked_servers dstdomain blocked-server

# ----------------------------------------------------------------------------
# URL REGEX PATTERNS
# ----------------------------------------------------------------------------
# Blocca pattern URL sospetti
acl suspicious_urls urlpath_regex -i \.exe$
acl suspicious_urls urlpath_regex -i \.bat$
acl suspicious_urls urlpath_regex -i \.cmd$
acl suspicious_urls urlpath_regex -i \.ps1$
acl suspicious_urls urlpath_regex -i /etc/passwd
acl suspicious_urls urlpath_regex -i /etc/shadow
acl suspicious_urls urlpath_regex -i \.\./

# Pattern SQL Injection nell'URL
acl sqli_patterns urlpath_regex -i union.*select
acl sqli_patterns urlpath_regex -i select.*from
acl sqli_patterns urlpath_regex -i insert.*into
acl sqli_patterns urlpath_regex -i drop.*table
acl sqli_patterns urlpath_regex -i or.*1.*=.*1
acl sqli_patterns urlpath_regex -i and.*1.*=.*1

# Pattern XSS nell'URL
acl xss_patterns urlpath_regex -i <script
acl xss_patterns urlpath_regex -i javascript:
acl xss_patterns urlpath_regex -i onerror.*=
acl xss_patterns urlpath_regex -i onload.*=

# ----------------------------------------------------------------------------
# REGOLE DI ACCESSO HTTP
# ----------------------------------------------------------------------------
# Nega richieste a porte non sicure
http_access deny !Safe_ports

# Nega CONNECT a porte non-SSL
http_access deny CONNECT !SSL_ports

# ===== REGOLE DI BLOCCO LAYER 7 =====

# Blocca domini in blacklist
http_access deny blocked_domains

# Blocca pattern domini bloccati inline
http_access deny blocked_domain_patterns

# Blocca server bloccati specifici
http_access deny blocked_servers

# Blocca URL sospetti
http_access deny suspicious_urls

# Blocca tentativi SQL injection
http_access deny sqli_patterns

# Blocca tentativi XSS
http_access deny xss_patterns

# ===== REGOLE ALLOW =====

# Consenti localhost
http_access allow localhost

# Consenti da reti interne/fidate
http_access allow internal_net
http_access allow dmz_net
http_access allow prod_net
http_access allow dev_net

# Consenti host esterni in whitelist
http_access allow whitelisted_external

# Consenti da qualsiasi sorgente in external_net che ha superato iptables
http_access allow external_net

# Nega tutto il resto
http_access deny all

# ----------------------------------------------------------------------------
# CONFIGURAZIONE CACHE
# ----------------------------------------------------------------------------
cache deny all

# Directory cache
cache_dir null /tmp

# Cache memoria
cache_mem 64 MB

# ----------------------------------------------------------------------------
# INOLTRO AL PEP
# ----------------------------------------------------------------------------
never_direct allow all
cache_peer_access pep allow all

# ----------------------------------------------------------------------------
# CONFIGURAZIONE LOGGING
# ----------------------------------------------------------------------------
# Formato log per Splunk
logformat zerotrust %ts.%03tu %6tr %>a %Ss/%03>Hs %<st %rm %ru %[un %Sh/%<a %mt "%{X-Real-IP}>h" "%{User-Agent}>h"

access_log stdio:/var/log/squid/access.log zerotrust

cache_log stdio:/var/log/squid/cache.log

# ----------------------------------------------------------------------------
# TIMEOUT
# ----------------------------------------------------------------------------
# Timeout connessione
connect_timeout 30 seconds
read_timeout 60 seconds
request_timeout 60 seconds

# Timeout client
client_lifetime 1 hour
pconn_timeout 60 seconds

# ----------------------------------------------------------------------------
# IMPOSTAZIONI SICUREZZA
# ----------------------------------------------------------------------------
httpd_suppress_version_string on

# Header IP client
forwarded_for on
follow_x_forwarded_for allow all

request_header_access All allow all
request_header_access Authorization allow all
request_header_access X-Real-IP allow all
request_header_access X-Forwarded-For allow all

via on

# ----------------------------------------------------------------------------
# PAGINE DI ERRORE
# ----------------------------------------------------------------------------
# Info negazione per contenuto bloccato
deny_info TCP_DENIED blocked_domains
deny_info TCP_DENIED blocked_domain_patterns
deny_info TCP_DENIED blocked_servers
deny_info TCP_DENIED suspicious_urls
deny_info TCP_DENIED sqli_patterns
deny_info TCP_DENIED xss_patterns

# ----------------------------------------------------------------------------
# ADMIN
# ----------------------------------------------------------------------------
# Hostname visibile
visible_hostname squid-proxy.techcorp.local

# Email admin
cache_mgr security@techcorp.local

# File PID
pid_filename /var/run/squid/squid.pid

coredump_dir /var/spool/squid
